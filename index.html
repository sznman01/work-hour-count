<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šç­å·¥æ™‚è¨ˆç®—å™¨</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .shadow-card { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .bounce { animation: bounce 0.5s ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-green { animation: pulseGreen 2s infinite; }
        @keyframes pulseGreen { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } }
        .success-toast { animation: toastIn 0.3s ease-out; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .error-toast { animation: toastIn 0.3s ease-out; background: linear-gradient(135deg, #ef4444, #dc2626); }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-indigo-100 min-h-screen p-4">
    <div id="app" class="max-w-md mx-auto">
        <!-- è¨Šæ¯æç¤º -->
        <div v-if="showSuccessToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-8 py-4 rounded-2xl shadow-2xl z-50 success-toast flex items-center">
            <span class="mr-3 text-xl">âœ…</span>
            <span>å„²å­˜æˆåŠŸï¼</span>
        </div>
        <div v-if="showErrorToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-red-500 to-red-600 text-white px-8 py-4 rounded-2xl shadow-2xl z-50 error-toast flex items-center">
            <span class="mr-3 text-xl">âŒ</span>
            <span>{{ errorMessage }}</span>
        </div>

        <!-- é ‚ç½®æœ¬æœˆç¸½å·¥æ™‚ -->
        <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-8 mb-6 shadow-card shadow-pink-200 slide-up pulse-green">
            <div class="text-center">
                <div class="text-3xl font-bold text-gray-800 mb-2" :class="{'animate-pulse text-green-600': totalChanged}">{{ formatMonthTotal }}</div>
                <div class="text-sm text-gray-500 mb-4">æœ¬æœˆç¸½å·¥æ™‚ (å°æ™‚)</div>
                <div class="text-xs bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-medium">
                    {{ currentMonth }}æœˆ
                </div>
            </div>
        </div>

        <!-- æ–°å¢å·¥ä½œæ—¥æŒ‰éˆ•å¡ç‰‡ -->
        <div v-if="!showAddForm" class="bg-white/90 backdrop-blur-sm rounded-3xl p-8 mb-6 shadow-card shadow-blue-200 text-center cursor-pointer hover:shadow-xl transform hover:-translate-y-2 transition-all duration-300" @click="toggleAddForm">
            <div class="text-4xl mb-4">â•</div>
            <div class="text-xl font-bold text-gray-800 mb-2">æ–°å¢å·¥ä½œæ—¥</div>
            <div class="text-sm text-gray-500">é»æ“Šè¼¸å…¥ä»Šæ—¥å·¥æ™‚</div>
        </div>

        <!-- æ–°å¢å·¥ä½œæ—¥è¼¸å…¥è¡¨æ ¼ -->
        <div v-if="showAddForm" class="bg-white/95 backdrop-blur-sm rounded-3xl p-6 mb-6 shadow-card shadow-blue-300 slide-up border-4 border-blue-100 relative">
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-blue-200">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <span class="mr-2 text-2xl">â•</span>æ–°å¢å·¥ä½œæ—¥
                </h2>
                <button @click="toggleAddForm" class="text-gray-500 hover:text-gray-700 text-2xl font-bold p-2 hover:bg-gray-200 rounded-2xl transition-all shadow-sm">âœ•</button>
            </div>
            
            <div class="space-y-4">
                <!-- æ—¥æœŸé¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <span class="mr-2">ğŸ“…</span>æ—¥æœŸ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        v-model="newWorkDay.date" 
                        type="date" 
                        class="w-full p-4 border-2 rounded-2xl text-lg transition-all shadow-sm"
                        :class="newWorkDay.date ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'"
                        :max="today"
                    >
                </div>

                <!-- å·¥æ™‚é¡å‹é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <span class="mr-2">â°</span>å·¥æ™‚é¡å‹ <span class="text-red-500">*</span>
                    </label>
                    <select 
                        v-model="newWorkDay.type" 
                        @change="handleTypeChange"
                        class="w-full p-4 border-2 rounded-2xl text-lg appearance-none bg-white transition-all shadow-sm"
                        :class="newWorkDay.type ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'"
                    >
                        <option value="">è«‹é¸æ“‡é¡å‹</option>
                        <option value="TC">TC (+9.25h)</option>
                        <option value="B">B (+10.72h)</option>
                        <option value="C">C (+9.5h)</option>
                        <option value="BC">BC (+10.25h)</option>
                        <option value="SP">SP (+12.25h)</option>
                        <option value="SPC">SPC (+11.25h)</option>
                        <option value="SL">SL (9.6h)</option>
                        <option value="TIL">TIL (-9.6h)</option>
                        <option value="custom">è‡ªè¨‚æ™‚æ•¸</option>
                    </select>
                </div>

                <!-- OT é¸æ“‡ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <span class="mr-2">â­</span>OT åŠ ç­
                    </label>
                    <select 
                        v-model="newWorkDay.ot" 
                        class="w-full p-4 border border-gray-200 rounded-2xl focus:ring-4 focus:ring-purple-200 focus:border-purple-400 text-lg appearance-none bg-white transition-all shadow-sm"
                    >
                        <option value="0">ç„¡ OT</option>
                        <option value="0.5">+0.5 å°æ™‚</option>
                        <option value="1">+1 å°æ™‚</option>
                        <option value="1.5">+1.5 å°æ™‚</option>
                        <option value="2">+2 å°æ™‚</option>
                        <option value="2.5">+2.5 å°æ™‚</option>
                        <option value="3">+3 å°æ™‚</option>
                    </select>
                </div>

                <!-- è‡ªè¨‚æ™‚æ•¸è¼¸å…¥ -->
                <div v-if="newWorkDay.type === 'custom'">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <span class="mr-2">âœï¸</span>è‡ªè¨‚å·¥æ™‚ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        v-model.number="newWorkDay.customHours" 
                        type="number" 
                        step="0.1"
                        min="-24" max="24"
                        class="w-full p-4 border-2 rounded-2xl text-lg transition-all shadow-sm"
                        :class="isCustomHoursValid ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'"
                        placeholder="0.0"
                    >
                </div>

                <!-- å³æ™‚é è¦½ç¸½æ™‚æ•¸ -->
                <div v-if="previewHours !== null" class="bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-2xl p-4 text-center shadow-lg border-4 border-green-200/50">
                    <div class="text-sm opacity-90 mb-1">å³æ™‚é è¦½ç¸½å·¥æ™‚</div>
                    <div class="text-2xl font-bold drop-shadow-lg">{{ previewHours.toFixed(2) }} å°æ™‚</div>
                </div>

                <!-- å„²å­˜ç‹€æ…‹æç¤º -->
                <div v-if="!isValidInput" class="bg-red-50 border-2 border-red-200 rounded-2xl p-4 text-center">
                    <div class="text-sm text-red-700 font-medium mb-1">âš ï¸ è«‹å®Œæˆå¿…å¡«é …ç›®</div>
                    <div class="text-xs text-red-500">
                        {{ getValidationMessage }}
                    </div>
                </div>

                <!-- æ–°å¢æŒ‰éˆ• -->
                <button 
                    @click="addWorkDay"
                    :disabled="!isValidInput || isSaving"
                    :class="[
                        'w-full font-bold py-5 px-8 rounded-2xl text-lg shadow-2xl hover:shadow-3xl transform hover:-translate-y-2 transition-all duration-300 flex items-center justify-center text-xl relative overflow-hidden',
                        isValidInput && !isSaving
                            ? 'bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-600 text-white bounce cursor-pointer' 
                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    ]"
                >
                    <div v-if="isSaving" class="absolute inset-0 bg-white/30 flex items-center justify-center">
                        <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <span :class="{ 'opacity-0': isSaving }">{{ isSaving ? 'å„²å­˜ä¸­...' : 'âœ¨ å„²å­˜å·¥ä½œæ—¥' }}</span>
                </button>
            </div>
        </div>

        <!-- æœ¬æœˆå·¥æ™‚æ˜ç´°å¡ç‰‡ -->
        <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-card shadow-indigo-200 slide-up">
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
                ğŸ“Š æœ¬æœˆå·¥æ™‚æ˜ç´°
                <span v-if="currentMonthWorkDays.length === 0" class="ml-2 text-sm text-gray-400">(æš«ç„¡è¨˜éŒ„)</span>
            </h2>
            
            <div class="grid grid-cols-7 gap-2 text-center mb-6">
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">æ—¥</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">ä¸€</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">äºŒ</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">ä¸‰</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">å››</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">äº”</div>
                <div class="font-bold text-gray-700 p-3 bg-gray-100 rounded-xl text-sm">å…­</div>
            </div>

            <div class="grid grid-cols-7 gap-2">
                <div 
                    v-for="(day, index) in currentMonthCalendarDays" 
                    :key="index"
                    class="p-3 rounded-xl min-h-[70px] flex flex-col justify-center cursor-pointer hover:scale-[1.02] transition-all duration-200 group relative border-2 hover:shadow-md"
                    :class="getDayClass(day)"
                    @click="day.date && editDay(day.date)"
                >
                    <div v-if="!day.date" class="opacity-30">&nbsp;</div>
                    <div v-else class="font-bold text-sm mb-1 leading-tight">{{ day.day }}</div>
                    
                    <div v-if="day.hasRecord" class="text-xs leading-tight">
                        <div class="font-medium">{{ formatHours(day.hours) }}</div>
                        <div v-if="day.ot > 0" class="text-yellow-500 text-[10px] mt-1">â­{{ day.ot }}</div>
                    </div>
                    <div v-else-if="day.date" class="text-gray-400 text-xs leading-tight">â€”</div>
                    
                    <div v-if="day.type && day.type !== 'custom' && day.date" class="absolute top-1 right-1 w-7 h-7 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-[10px] font-bold shadow-lg text-gray-700 border">
                        {{ day.type }}
                    </div>
                </div>
            </div>
        </div>

        <!-- ç·¨è¼¯å½ˆçª— -->
        <div v-if="showEditModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl border-4 border-green-200 animate-in slide-in-from-bottom-4 duration-300">
                <h3 class="text-xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
                    <span class="mr-2">âœï¸</span>ç·¨è¼¯ {{ editDate }}
                </h3>
                <div class="relative mb-8">
                    <input 
                        v-model.number="editHours" 
                        type="number" 
                        step="0.1"
                        class="w-full p-6 border-2 border-gray-200 rounded-2xl text-xl text-center font-bold focus:ring-4 focus:ring-green-300 focus:border-green-400 transition-all shadow-inner"
                        placeholder="è¼¸å…¥å·¥æ™‚..."
                    >
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-2xl">â±ï¸</span>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button 
                        @click="saveEdit"
                        :disabled="editHours === null || isNaN(editHours)"
                        :class="[
                            'flex-1 font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all flex items-center justify-center',
                            editHours !== null && !isNaN(editHours) ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        ]"
                    >
                        âœ… ç¢ºå®šå„²å­˜
                    </button>
                    <button 
                        @click="cancelEdit"
                        class="flex-1 bg-gradient-to-r from-gray-400 to-gray-500 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all"
                    >
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentMonth: new Date().getMonth() + 1,
                    currentYear: new Date().getFullYear(),
                    showAddForm: false,
                    showSuccessToast: false,
                    showErrorToast: false,
                    errorMessage: '',
                    totalChanged: false,
                    isSaving: false,
                    workDays: {},
                    newWorkDay: {
                        date: '',
                        type: '',
                        ot: '0',
                        customHours: null
                    },
                    showEditModal: false,
                    editDate: '',
                    editHours: null,
                    workTypes: {
                        'TC': 9.25,
                        'B': 10.72,
                        'C': 9.5,
                        'BC': 10.25,
                        'SP': 12.25,
                        'SPC': 11.25,
                        'SL': 9.6,
                        'TIL': -9.6
                    }
                }
            },
            computed: {
                today() {
                    return new Date().toISOString().split('T')[0];
                },
                formatMonthTotal() {
                    return this.getMonthTotal().toFixed(2);
                },
                previewHours() {
                    if (!this.isValidInput) return null;
                    const baseHours = this.getHoursForDay();
                    const otHours = parseFloat(this.newWorkDay.ot || 0);
                    return baseHours + otHours;
                },
                isCustomHoursValid() {
                    if (this.newWorkDay.type !== 'custom') return true;
                    const hours = parseFloat(this.newWorkDay.customHours);
                    return !isNaN(hours) && hours !== null && hours !== undefined;
                },
                isValidInput() {
                    if (!this.newWorkDay.date) return false;
                    if (!this.newWorkDay.type) return false;
                    if (this.newWorkDay.type === 'custom') {
                        return this.isCustomHoursValid;
                    }
                    return true;
                },
                getValidationMessage() {
                    if (!this.newWorkDay.date) return 'è«‹é¸æ“‡æ—¥æœŸ';
                    if (!this.newWorkDay.type) return 'è«‹é¸æ“‡å·¥æ™‚é¡å‹';
                    if (this.newWorkDay.type === 'custom' && !this.isCustomHoursValid) {
                        return 'è«‹è¼¸å…¥æœ‰æ•ˆè‡ªè¨‚å·¥æ™‚';
                    }
                    return '';
                },
                currentMonthWorkDays() {
                    return Object.values(this.workDays).filter(day => {
                        if (!day?.date) return false;
                        try {
                            const date = new Date(day.date);
                            return date.getFullYear() === this.currentYear && date.getMonth() + 1 === this.currentMonth;
                        } catch {
                            return false;
                        }
                    });
                },
                currentMonthCalendarDays() {
                    const days = [];
                    const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                    const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                    const startOffset = firstDay.getDay();
                    
                    // å‰ç½®ç©ºç™½æ ¼
                    for (let i = 0; i < startOffset; i++) {
                        days.push({ date: '', day: '', hasRecord: false });
                    }
                    
                    // æœ¬æœˆæ—¥æœŸ
                    for (let dayNum = 1; dayNum <= lastDay.getDate(); dayNum++) {
                        const dateStr = `${this.currentYear}-${String(this.currentMonth).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
                        const workDay = this.workDays[dateStr];
                        
                        days.push({
                            date: dateStr,
                            day: dayNum,
                            hours: workDay ? workDay.hours : null,
                            ot: workDay ? (workDay.ot || 0) : 0,
                            type: workDay ? workDay.type : null,
                            hasRecord: !!workDay
                        });
                    }
                    
                    return days;
                }
            },
            watch: {
                workDays: {
                    handler() {
                        this.totalChanged = true;
                        setTimeout(() => this.totalChanged = false, 2000);
                        this.saveData();
                    },
                    deep: true
                },
                'newWorkDay.date'(newDate) {
                    if (newDate && this.showAddForm) {
                        const existing = this.workDays[newDate];
                        if (existing) {
                            this.newWorkDay.type = existing.type || '';
                            this.newWorkDay.ot = (existing.ot || 0).toString();
                            if (existing.type === 'custom') {
                                this.newWorkDay.customHours = existing.customHours || null;
                            }
                        } else {
                            this.newWorkDay.type = '';
                            this.newWorkDay.ot = '0';
                            this.newWorkDay.customHours = null;
                        }
                    }
                }
            },
            methods: {
                toggleAddForm() {
                    this.showAddForm = !this.showAddForm;
                    if (this.showAddForm) {
                        this.$nextTick(() => {
                            this.newWorkDay.date = this.today;
                        });
                    }
                },
                handleTypeChange() {
                    if (this.newWorkDay.type !== 'custom') {
                        this.newWorkDay.customHours = null;
                    }
                },
                getHoursForDay() {
                    if (this.newWorkDay.type === 'custom') {
                        const hours = parseFloat(this.newWorkDay.customHours);
                        return isNaN(hours) ? 0 : hours;
                    }
                    return this.workTypes[this.newWorkDay.type] || 0;
                },
                addWorkDay() {
                    console.log('é–‹å§‹å„²å­˜:', this.newWorkDay); // é™¤éŒ¯ç”¨
                    
                    if (!this.isValidInput) {
                        this.showError('è«‹æª¢æŸ¥å¿…å¡«é …ç›®');
                        return;
                    }

                    this.isSaving = true;
                    this.showErrorToast = false;

                    // å»¶é²ç¢ºä¿ UI æ›´æ–°
                    setTimeout(() => {
                        try {
                            const dateKey = this.newWorkDay.date;
                            const hours = this.getHoursForDay();
                            const otHours = parseFloat(this.newWorkDay.ot || 0);
                            const totalHours = hours + otHours;

                            console.log('å„²å­˜æ•¸æ“š:', { dateKey, hours, otHours, totalHours });

                            // ç›´æ¥è³¦å€¼çµ¦ Vue éŸ¿æ‡‰å¼å°è±¡
                            this.workDays[dateKey] = {
                                hours: totalHours,
                                type: this.newWorkDay.type,
                                ot: otHours,
                                customHours: this.newWorkDay.type === 'custom' ? hours : null,
                                date: dateKey
                            };

                            // è§¸ç™¼éŸ¿æ‡‰å¼æ›´æ–°
                            this.$forceUpdate();

                            // é¡¯ç¤ºæˆåŠŸ
                            this.showSuccess();

                            // é‡ç½®ä¸¦é—œé–‰
                            this.newWorkDay = { date: this.today, type: '', ot: '0', customHours: null };
                            this.showAddForm = false;

                        } catch (error) {
                            console.error('å„²å­˜éŒ¯èª¤:', error);
                            this.showError('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
                        } finally {
                            this.isSaving = false;
                        }
                    }, 100);
                },
                showSuccess() {
                    this.showSuccessToast = true;
                    setTimeout(() => this.showSuccessToast = false, 2000);
                },
                showError(message) {
                    this.errorMessage = message;
                    this.showErrorToast = true;
                    setTimeout(() => this.showErrorToast = false, 3000);
                },
                getMonthTotal() {
                    let total = 0;
                    this.currentMonthWorkDays.forEach(day => {
                        total += parseFloat(day.hours || 0);
                    });
                    return total;
                },
                formatHours(hours) {
                    if (!hours || isNaN(hours)) return '';
                    return parseFloat(hours).toFixed(2);
                },
                getDayClass(day) {
                    if (!day.date) return 'bg-gray-50 border-gray-200 opacity-30';
                    if (!day.hasRecord) return 'bg-gray-50 border-gray-200 hover:border-gray-300';
                    
                    const hours = parseFloat(day.hours || 0);
                    if (hours > 10) return 'bg-emerald-100 border-emerald-400 shadow-md hover:shadow-emerald-300';
                    if (hours > 0) return 'bg-green-100 border-green-400 shadow-sm hover:shadow-green-200';
                    if (hours < 0) return 'bg-red-100 border-red-400 shadow-md hover:shadow-red-300';
                    return 'bg-yellow-100 border-yellow-400 hover:shadow-yellow-200';
                },
                editDay(date) {
                    const workDay = this.workDays[date];
                    if (workDay) {
                        this.editDate = date;
                        this.editHours = workDay.hours;
                        this.showEditModal = true;
                    }
                },
                saveEdit() {
                    if (this.editHours !== null && !isNaN(this.editHours)) {
                        this.workDays[this.editDate] = {
                            ...this.workDays[this.editDate],
                            hours: parseFloat(this.editHours)
                        };
                        this.$forceUpdate();
                        this.showSuccess();
                    }
                    this.cancelEdit();
                },
                cancelEdit() {
                    this.showEditModal = false;
                    this.editDate = '';
                    this.editHours = null;
                },
                saveData() {
                    try {
                        localStorage.setItem('workDays', JSON.stringify(this.workDays));
                    } catch (e) {
                        console.warn('localStorage å„²å­˜å¤±æ•—:', e);
                    }
                }
            },
            mounted() {
                try {
                    const saved = localStorage.getItem('workDays');
                    if (saved) {
                        this.workDays = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('è¼‰å…¥å¤±æ•—:', e);
                }
                this.newWorkDay.date = this.today;
            }
        }).mount('#app');
    </script>
</body>
</html>
