<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å“¡å·¥å·¥æ™‚è¨ˆç®—å™¨</title>

  <!-- iOSï¼ˆåŠ å…¥ä¸»ç•«é¢ iconï¼‰ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å·¥æ™‚è¨ˆç®—">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120x120.png">

  <!-- ä¸€èˆ¬ faviconï¼ˆSafari tab ç”¨ï¼‰ -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">

  <!-- PWAï¼ˆAndroid/æ¡Œé¢ç”¨ï¼›iOS æœƒä¸»è¦ç‡ apple-touch-iconï¼‰ -->
  <meta name="theme-color" content="#667eea">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    .shadow-card { box-shadow: 0 10px 30px rgba(0,0,0,0.10); }
    .slide-up { animation: slideUp 0.25s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
    .toast-in { animation: toastIn 0.25s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-50 to-indigo-100 min-h-screen p-4 flex flex-col">

  <div id="app" class="max-w-md mx-auto flex-grow pb-24">

    <!-- Toasts -->
    <div v-if="showSuccessToast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-green-600 text-white px-5 py-3 rounded-2xl shadow-2xl z-50 toast-in">
      âœ… {{ successMessage }}
    </div>
    <div v-if="showErrorToast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl z-50 toast-in">
      âš ï¸ {{ errorMessage }}
    </div>

    <!-- Month view -->
    <div v-if="currentView === 'month'" class="slide-up">

      <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-7 mb-5 shadow-card border border-white">
        <div class="text-center">
          <div class="text-sm text-gray-500 mb-1">æœ¬æœˆç¸½å·¥æ™‚ (å°æ™‚)</div>
          <div class="text-4xl font-bold text-gray-800 mb-3">{{ monthTotal.toFixed(2) }}</div>

          <!-- Remaining hours to reach 208 -->
          <div class="text-sm bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 inline-block">
            <span class="text-gray-600">æœ¬æœˆç›®æ¨™ï¼š</span>
            <span class="font-bold text-gray-800">{{ monthlyTarget }}</span>
            <span class="text-gray-600"> å°æ™‚</span>
            <span class="mx-2 text-gray-300">|</span>
            <span v-if="monthDiff < 0" class="font-bold text-red-700">ä»²å·® {{ (-monthDiff).toFixed(2) }} å°æ™‚</span>
            <span v-else class="font-bold text-emerald-700">å·²é”æ¨™ï¼ˆè¶…å‡º {{ monthDiff.toFixed(2) }} å°æ™‚ï¼‰</span>
          </div>

          <div class="mt-4 inline-flex items-center gap-2">
            <span class="text-xs bg-pink-100 text-pink-700 px-3 py-1 rounded-full font-medium">{{ currentYear }} å¹´</span>
            <span class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-medium">{{ currentMonth }} æœˆ</span>
          </div>
        </div>
      </div>

      <!-- Big card to enter input panel -->
      <div v-if="!showAddForm" class="bg-white/90 backdrop-blur-sm rounded-2xl p-4 mb-5 shadow-card text-center cursor-pointer hover:bg-indigo-50 transition" @click="toggleAddForm()">
        <div class="text-lg font-bold text-gray-800">â• æ–°å¢ï¼æ›´æ–°å·¥ä½œæ—¥</div>
        <div class="text-xs text-gray-500 mt-1">é¸æ—¥æœŸå¾Œï¼Œå¦‚è©²æ—¥å·²æœ‰è¨˜éŒ„æœƒç›´æ¥è¦†è“‹æ›´æ–°</div>
      </div>

      <!-- Input panel -->
      <div v-if="showAddForm" class="bg-white/95 backdrop-blur-sm rounded-3xl p-6 mb-5 shadow-card border-2 border-indigo-100 slide-up">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">æ–°å¢ï¼æ›´æ–°å·¥ä½œæ—¥</h2>
          <button class="text-gray-500 hover:text-gray-700 text-2xl font-bold px-2" @click="toggleAddForm()">Ã—</button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ <span class="text-red-500">*</span></label>
            <input v-model="newWorkDay.date" type="date" :max="today" class="w-full p-4 border-2 rounded-2xl text-lg bg-white focus:ring-4 focus:ring-indigo-200 focus:border-indigo-400 transition" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">å·¥æ™‚é¡å‹ <span class="text-red-500">*</span></label>
            <select v-model="newWorkDay.type" @change="handleTypeChange('new')" class="w-full p-4 border-2 rounded-2xl text-lg bg-white focus:ring-4 focus:ring-indigo-200 focus:border-indigo-400 transition">
              <option value="">è«‹é¸æ“‡é¡å‹</option>
              <option v-for="(h, k) in workTypes" :key="k" :value="k">{{ k }} ({{ h>=0 ? '+' : '' }}{{ h }}h)</option>
              <option value="custom">è‡ªè¨‚æ™‚æ•¸</option>
            </select>
          </div>

          <div v-if="newWorkDay.type === 'custom'">
            <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªè¨‚å·¥æ™‚ï¼ˆä¸å«OTï¼‰ <span class="text-red-500">*</span></label>
            <input v-model.number="newWorkDay.customHours" type="number" step="0.1" min="-24" max="24" class="w-full p-4 border-2 rounded-2xl text-lg bg-white focus:ring-4 focus:ring-indigo-200 focus:border-indigo-400 transition" placeholder="ä¾‹å¦‚ï¼š8.0" />
            <div class="text-xs text-gray-500 mt-1">å¯è¼¸å…¥è² æ•¸ï¼ˆä¾‹å¦‚è£œå‡ï¼æ‰£æ™‚ï¼‰</div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">OT åŠ ç­</label>
            <select v-model="newWorkDay.ot" class="w-full p-4 border-2 rounded-2xl text-lg bg-white focus:ring-4 focus:ring-indigo-200 focus:border-indigo-400 transition">
              <option value="0">ç„¡ OT</option>
              <option value="0.25">+0.25 å°æ™‚</option>
              <option value="0.5">+0.5 å°æ™‚</option>
              <option value="1">+1 å°æ™‚</option>
              <option value="1.5">+1.5 å°æ™‚</option>
              <option value="2">+2 å°æ™‚</option>
              <option value="2.5">+2.5 å°æ™‚</option>
              <option value="3">+3 å°æ™‚</option>
            </select>
          </div>

          <div v-if="newPreviewHours !== null" class="bg-gradient-to-r from-emerald-500 to-green-500 text-white rounded-2xl p-4 text-center shadow">
            <div class="text-xs opacity-90 mb-1">å³æ™‚é è¦½ç¸½å·¥æ™‚</div>
            <div class="text-2xl font-bold">{{ newPreviewHours.toFixed(2) }} å°æ™‚</div>
          </div>

          <div v-if="newValidationMessage" class="bg-red-50 border border-red-200 rounded-2xl p-4 text-center">
            <div class="text-sm text-red-700 font-medium">âš ï¸ {{ newValidationMessage }}</div>
          </div>

          <button @click="saveNewWorkDay()" :disabled="isSaving || !!newValidationMessage" class="w-full font-bold py-4 px-6 rounded-2xl text-lg shadow-lg transition flex items-center justify-center"
                  :class="(!isSaving && !newValidationMessage) ? 'bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-600 text-white hover:opacity-95' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
            <span v-if="!isSaving">âœ¨ å„²å­˜å·¥ä½œæ—¥</span>
            <span v-else>å„²å­˜ä¸­â€¦</span>
          </button>
        </div>
      </div>

      <!-- Month details -->
      <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-card slide-up">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">ğŸ“Š æœ¬æœˆå·¥æ™‚æ˜ç´°</h2>
          <button class="text-sm px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 transition" @click="showMonthList = !showMonthList">
            {{ showMonthList ? 'æ”¶èµ·åˆ—è¡¨' : 'å±•é–‹åˆ—è¡¨' }}
          </button>
        </div>

        <!-- Calendar -->
        <div class="grid grid-cols-7 gap-2 text-center mb-4">
          <div class="font-bold text-gray-700 p-2 bg-gray-100 rounded-xl text-sm" v-for="w in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" :key="w">{{ w }}</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
          <div v-for="(day, idx) in currentMonthCalendarDays" :key="idx"
               class="p-3 rounded-xl min-h-[62px] flex flex-col justify-center cursor-pointer transition border-2 text-center"
               :class="getDayClass(day)"
               @click="day.date && day.hasRecord ? openEdit(day.date) : null">

            <div v-if="day.date" class="font-bold text-sm mb-1">{{ day.day }}</div>
            <div v-if="day.hasRecord" class="text-xs font-semibold text-gray-800">{{ formatHours(day.hours) }}</div>
            <div v-if="day.hasRecord && day.ot > 0" class="text-[10px] text-yellow-600 mt-1">OT +{{ day.ot }}</div>
            <div v-if="day.date && !day.hasRecord" class="text-[10px] text-gray-400">â€”</div>
            <div v-if="!day.date" class="opacity-30">&nbsp;</div>
          </div>
        </div>

        <!-- List for editing entry points -->
        <div v-if="showMonthList" class="mt-5">
          <div v-if="currentMonthWorkDaysSorted.length === 0" class="text-center text-sm text-gray-500 py-6">(æš«ç„¡è¨˜éŒ„)</div>
          <div v-else class="space-y-3">
            <div v-for="day in currentMonthWorkDaysSorted" :key="day.date" class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center shadow-sm">
              <div>
                <div class="font-bold text-gray-800">{{ day.date }}</div>
                <div class="text-xs text-gray-600 mt-1">é¡å‹: {{ day.type === 'custom' ? 'è‡ªè¨‚' : day.type }}<span v-if="day.ot>0">ï¼ŒOT +{{ day.ot }}</span></div>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right">
                  <div class="text-lg font-bold" :class="day.hours >= 0 ? 'text-emerald-600' : 'text-red-600'">{{ formatHours(day.hours) }}</div>
                  <div class="text-[11px] text-gray-500">å°æ™‚</div>
                </div>
                <button class="px-3 py-2 rounded-xl bg-white border hover:bg-indigo-50 transition" @click="openEdit(day.date)">âœï¸</button>
              </div>
            </div>
          </div>
        </div>

        <div class="text-[11px] text-gray-500 mt-4">æç¤ºï¼šæ—¥æ›†ä¸Šå·²æœ‰è¨˜éŒ„çš„æ—¥å­å¯ç›´æ¥é»æ“Šé€²è¡Œæ›´æ”¹ã€‚</div>
      </div>
    </div>

    <!-- History view -->
    <div v-if="currentView === 'history'" class="slide-up">

      <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-7 mb-5 shadow-card border border-white">
        <div class="text-center">
          <div class="text-sm text-gray-500 mb-1">æ­·å²ç¸½å·¥æ™‚ (è‡³ä»Š)</div>
          <div class="text-4xl font-bold text-gray-800 mb-3">{{ lifetimeTotal.toFixed(2) }}</div>

          <!-- Monthly balance sum vs 208 per month -->
          <div class="text-sm bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 inline-block">
            <span class="text-gray-600">æˆªè‡³ä»Šæ—¥å·¥ä½œæ™‚æ•¸çµé¤˜ï¼š</span>
            <span class="font-bold" :class="lifetimeBalance < 0 ? 'text-red-700' : 'text-emerald-700'">
              {{ lifetimeBalance.toFixed(2) }}
            </span>
            <span class="text-gray-600"> å°æ™‚</span>
          </div>

          <div class="text-xs text-gray-500 mt-3">ï¼ˆçµé¤˜è¨ˆæ³•ï¼šæ¯æœˆåˆè¨ˆ âˆ’ 208ï¼›ç„¶å¾Œå°‡æ‰€æœ‰æœ‰è¨˜éŒ„å˜…æœˆä»½åŠ ç¸½ï¼‰</div>
        </div>
      </div>

      <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-card mb-5">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">å¹´ä»½</label>
            <select v-model="historyYear" class="w-full p-3 border-2 rounded-2xl bg-white">
              <option v-for="y in availableYears" :key="y" :value="String(y)">{{ y }} å¹´</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">æœˆä»½</label>
            <select v-model="historyMonth" class="w-full p-3 border-2 rounded-2xl bg-white">
              <option v-for="m in 12" :key="m" :value="String(m)">{{ m }} æœˆ</option>
            </select>
          </div>
        </div>

        <div class="mt-4 bg-gray-50 rounded-2xl p-4 flex justify-between items-center">
          <div class="text-sm text-gray-700">æ‰€é¸æœˆä»½åˆè¨ˆ</div>
          <div class="text-xl font-bold text-indigo-700">{{ historyMonthTotal.toFixed(2) }} å°æ™‚</div>
        </div>
      </div>

      <!-- History month calendar (same style as current month, but readonly) -->
      <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800">ğŸ“œ æ­·å²æœˆæ›†</h2>
          <div class="text-xs text-gray-500">{{ historyYear }} å¹´ {{ historyMonth }} æœˆ</div>
        </div>

        <div class="grid grid-cols-7 gap-2 text-center mb-4">
          <div class="font-bold text-gray-700 p-2 bg-gray-100 rounded-xl text-sm" v-for="w in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" :key="w">{{ w }}</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
          <div v-for="(day, idx) in historyMonthCalendarDays" :key="idx"
               class="p-3 rounded-xl min-h-[62px] flex flex-col justify-center transition border-2 text-center"
               :class="getDayClass(day)">

            <div v-if="day.date" class="font-bold text-sm mb-1">{{ day.day }}</div>
            <div v-if="day.hasRecord" class="text-xs font-semibold text-gray-800">{{ formatHours(day.hours) }}</div>
            <div v-if="day.hasRecord && day.ot > 0" class="text-[10px] text-yellow-600 mt-1">OT +{{ day.ot }}</div>
            <div v-if="day.date && !day.hasRecord" class="text-[10px] text-gray-400">â€”</div>
            <div v-if="!day.date" class="opacity-30">&nbsp;</div>
          </div>
        </div>

        <div class="text-[11px] text-gray-500 mt-4">æç¤ºï¼šæ­¤å€åªä½œæŸ¥çœ‹ç”¨é€”ï¼Œå¦‚éœ€ä¿®æ”¹ç´€éŒ„è«‹åˆ°ã€Œæœ¬æœˆã€æˆ–ç”¨åˆ—è¡¨ä¸­ç·¨è¼¯æŒ‰éˆ•ã€‚</div>
      </div>
    </div>

    <!-- Edit modal -->
    <div v-if="showEditModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl border border-white slide-up">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold text-gray-800">ç·¨è¼¯ {{ editForm.date }}</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl font-bold px-2" @click="closeEdit()">Ã—</button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">å·¥æ™‚é¡å‹</label>
            <select v-model="editForm.type" @change="handleTypeChange('edit')" class="w-full p-3 border-2 rounded-2xl bg-white">
              <option v-for="(h, k) in workTypes" :key="k" :value="k">{{ k }} ({{ h>=0 ? '+' : '' }}{{ h }}h)</option>
              <option value="custom">è‡ªè¨‚æ™‚æ•¸</option>
            </select>
          </div>

          <div v-if="editForm.type === 'custom'">
            <label class="block text-xs font-medium text-gray-600 mb-2">è‡ªè¨‚å·¥æ™‚ï¼ˆä¸å«OTï¼‰</label>
            <input v-model.number="editForm.customHours" type="number" step="0.1" min="-24" max="24" class="w-full p-3 border-2 rounded-2xl bg-white" />
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">OT åŠ ç­</label>
            <select v-model="editForm.ot" class="w-full p-3 border-2 rounded-2xl bg-white">
              <option value="0">ç„¡ OT</option>
              <option value="0.5">+0.5 å°æ™‚</option>
              <option value="1">+1 å°æ™‚</option>
              <option value="1.5">+1.5 å°æ™‚</option>
              <option value="2">+2 å°æ™‚</option>
              <option value="2.5">+2.5 å°æ™‚</option>
              <option value="3">+3 å°æ™‚</option>
            </select>
          </div>

          <div class="bg-gray-50 rounded-2xl p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">æ­¤æ—¥ç¸½å·¥æ™‚</div>
            <div class="text-2xl font-bold" :class="editPreviewHours >= 0 ? 'text-emerald-700' : 'text-red-600'">{{ editPreviewHours.toFixed(2) }}</div>
          </div>

          <div class="flex gap-3 pt-2">
            <button class="flex-1 font-bold py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 transition" @click="saveEdit()">âœ… å„²å­˜</button>
            <button class="flex-1 font-bold py-3 rounded-2xl bg-gray-500 text-white hover:bg-gray-600 transition" @click="closeEdit()">âŒ å–æ¶ˆ</button>
          </div>

          <button class="w-full font-bold py-3 rounded-2xl bg-red-50 text-red-700 border border-red-200 hover:bg-red-100 transition" @click="deleteRecord(editForm.date)">ğŸ—‘ï¸ åˆªé™¤æ­¤æ—¥è¨˜éŒ„</button>
        </div>
      </div>
    </div>

    <!-- Bottom tab bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200">
      <div class="max-w-md mx-auto grid grid-cols-2">
        <button @click="switchView('month')" class="py-4 text-center font-medium"
                :class="currentView === 'month' ? 'text-indigo-700 border-t-2 border-indigo-700' : 'text-gray-500'">
          æœ¬æœˆ
        </button>
        <button @click="switchView('history')" class="py-4 text-center font-medium"
                :class="currentView === 'history' ? 'text-indigo-700 border-t-2 border-indigo-700' : 'text-gray-500'">
          æ­·å²è¨˜éŒ„
        </button>
      </div>
    </div>

  </div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      currentView: 'month',
      currentMonth: new Date().getMonth() + 1,
      currentYear: new Date().getFullYear(),

      monthlyTarget: 208,

      showAddForm: false,
      showMonthList: true,

      showSuccessToast: false,
      showErrorToast: false,
      successMessage: 'å„²å­˜æˆåŠŸï¼',
      errorMessage: '',
      isSaving: false,

      workDays: {},

      newWorkDay: {
        date: '',
        type: '',
        ot: '0',
        customHours: null
      },

      historyYear: String(new Date().getFullYear()),
      historyMonth: String(new Date().getMonth() + 1),

      showEditModal: false,
      editForm: {
        date: '',
        type: 'TC',
        ot: '0',
        customHours: null
      },

      workTypes: {
        'TC': 9.25,
        'B': 10.75,
        'C': 9.5,
        'BC': 10.25,
        'SP': 12.25,
        'SPC': 11.25,
        'SL': 9.6
      }
    };
  },

  computed: {
    today() {
      return new Date().toISOString().split('T')[0];
    },

    newValidationMessage() {
      if (!this.newWorkDay.date) return 'è«‹é¸æ“‡æ—¥æœŸ';
      if (!this.newWorkDay.type) return 'è«‹é¸æ“‡å·¥æ™‚é¡å‹';
      if (this.newWorkDay.type === 'custom') {
        const h = parseFloat(this.newWorkDay.customHours);
        if (Number.isNaN(h)) return 'è«‹è¼¸å…¥è‡ªè¨‚å·¥æ™‚';
      }
      return '';
    },

    newPreviewHours() {
      if (this.newValidationMessage) return null;
      return this.calcTotalHours(this.newWorkDay.type, this.newWorkDay.customHours, this.newWorkDay.ot);
    },

    currentMonthWorkDays() {
      return Object.values(this.workDays).filter(d => {
        if (!d || !d.date) return false;
        const dt = new Date(d.date);
        return dt.getFullYear() === this.currentYear && (dt.getMonth() + 1) === this.currentMonth;
      });
    },

    currentMonthWorkDaysSorted() {
      return [...this.currentMonthWorkDays].sort((a,b) => new Date(a.date) - new Date(b.date));
    },

    monthTotal() {
      return this.currentMonthWorkDays.reduce((sum, d) => sum + (parseFloat(d.hours) || 0), 0);
    },

    monthDiff() {
      return this.monthTotal - this.monthlyTarget;
    },

    currentMonthCalendarDays() {
      const days = [];
      const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
      const lastDay = new Date(this.currentYear, this.currentMonth, 0);
      const startOffset = firstDay.getDay();

      for (let i = 0; i < startOffset; i++) {
        days.push({ date: '', day: '', hasRecord: false });
      }

      for (let dayNum = 1; dayNum <= lastDay.getDate(); dayNum++) {
        const dateStr = `${this.currentYear}-${String(this.currentMonth).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
        const wd = this.workDays[dateStr];
        days.push({
          date: dateStr,
          day: dayNum,
          hasRecord: !!wd,
          hours: wd ? wd.hours : null,
          ot: wd ? (parseFloat(wd.ot) || 0) : 0,
          type: wd ? wd.type : null
        });
      }

      return days;
    },

    lifetimeTotal() {
      return Object.values(this.workDays).reduce((sum, d) => sum + (parseFloat(d?.hours) || 0), 0);
    },

    monthlyTotalsMap() {
      const map = {};
      Object.values(this.workDays).forEach(d => {
        if (!d?.date) return;
        const dt = new Date(d.date);
        if (Number.isNaN(dt.getTime())) return;
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const key = `${y}-${m}`;
        map[key] = (map[key] || 0) + (parseFloat(d.hours) || 0);
      });
      return map;
    },

    lifetimeBalance() {
      const totals = this.monthlyTotalsMap;
      return Object.keys(totals).reduce((sum, k) => sum + (totals[k] - this.monthlyTarget), 0);
    },

    availableYears() {
      const years = new Set([this.currentYear]);
      Object.values(this.workDays).forEach(d => {
        if (!d?.date) return;
        const y = new Date(d.date).getFullYear();
        if (!Number.isNaN(y)) years.add(y);
      });
      return Array.from(years).sort((a,b) => b - a);
    },

    historyMonthCalendarDays() {
      const year = parseInt(this.historyYear, 10);
      const month = parseInt(this.historyMonth, 10);
      const days = [];
      if (Number.isNaN(year) || Number.isNaN(month)) return days;

      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      const startOffset = firstDay.getDay();

      for (let i = 0; i < startOffset; i++) {
        days.push({ date: '', day: '', hasRecord: false });
      }

      for (let dayNum = 1; dayNum <= lastDay.getDate(); dayNum++) {
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
        const wd = this.workDays[dateStr];
        days.push({
          date: dateStr,
          day: dayNum,
          hasRecord: !!wd,
          hours: wd ? wd.hours : null,
          ot: wd ? (parseFloat(wd.ot) || 0) : 0,
          type: wd ? wd.type : null
        });
      }

      return days;
    },

    historyMonthTotal() {
      return this.historyMonthCalendarDays.reduce((sum, d) => sum + (parseFloat(d.hours) || 0), 0);
    },

    editPreviewHours() {
      return this.calcTotalHours(this.editForm.type, this.editForm.customHours, this.editForm.ot);
    }
  },

  watch: {
    workDays: {
      handler() { this.saveData(); },
      deep: true
    },

    'newWorkDay.date'(newDate) {
      if (!newDate) return;
      const existing = this.workDays[newDate];
      if (existing) {
        this.newWorkDay.type = existing.type || '';
        this.newWorkDay.ot = String(existing.ot ?? '0');
        this.newWorkDay.customHours = existing.type === 'custom' ? (existing.customHours ?? null) : null;
      } else {
        this.newWorkDay.type = '';
        this.newWorkDay.ot = '0';
        this.newWorkDay.customHours = null;
      }
    }
  },

  methods: {
    switchView(view) {
      this.currentView = view;
    },

    handleTypeChange(which) {
      if (which === 'new') {
        if (this.newWorkDay.type !== 'custom') this.newWorkDay.customHours = null;
      } else {
        if (this.editForm.type !== 'custom') this.editForm.customHours = null;
      }
    },

    toggleAddForm() {
      this.showAddForm = !this.showAddForm;
      if (this.showAddForm && !this.newWorkDay.date) {
        this.newWorkDay.date = this.today;
      }
    },

    showSuccess(msg = 'å„²å­˜æˆåŠŸï¼') {
      this.successMessage = msg;
      this.showSuccessToast = true;
      setTimeout(() => (this.showSuccessToast = false), 1800);
    },

    showError(msg) {
      this.errorMessage = msg;
      this.showErrorToast = true;
      setTimeout(() => (this.showErrorToast = false), 2600);
    },

    getBaseHours(type, customHours) {
      if (type === 'custom') {
        const h = parseFloat(customHours);
        return Number.isNaN(h) ? 0 : h;
      }
      return this.workTypes[type] ?? 0;
    },

    calcTotalHours(type, customHours, ot) {
      const base = this.getBaseHours(type, customHours);
      const otH = parseFloat(ot ?? 0) || 0;
      return base + otH;
    },

    saveNewWorkDay() {
      if (this.newValidationMessage) {
        this.showError(this.newValidationMessage);
        return;
      }

      this.isSaving = true;
      setTimeout(() => {
        try {
          const dateKey = this.newWorkDay.date;
          const total = this.calcTotalHours(this.newWorkDay.type, this.newWorkDay.customHours, this.newWorkDay.ot);
          const otH = parseFloat(this.newWorkDay.ot ?? 0) || 0;
          const customH = this.newWorkDay.type === 'custom' ? (parseFloat(this.newWorkDay.customHours) || 0) : null;

          this.workDays[dateKey] = {
            date: dateKey,
            type: this.newWorkDay.type,
            ot: otH,
            customHours: customH,
            hours: parseFloat(total.toFixed(2))
          };

          this.showSuccess('å·²å„²å­˜ï¼');
          this.showAddForm = false;
        } catch (e) {
          console.error(e);
          this.showError('å„²å­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        } finally {
          this.isSaving = false;
        }
      }, 120);
    },

    openEdit(date) {
      const d = this.workDays[date];
      if (!d) return;

      this.editForm = {
        date: d.date,
        type: d.type || 'TC',
        ot: String(d.ot ?? '0'),
        customHours: d.type === 'custom' ? (d.customHours ?? 0) : null
      };

      this.showEditModal = true;
    },

    closeEdit() {
      this.showEditModal = false;
    },

    saveEdit() {
      if (!this.editForm.date) return;
      if (!this.editForm.type) {
        this.showError('è«‹é¸æ“‡å·¥æ™‚é¡å‹');
        return;
      }
      if (this.editForm.type === 'custom') {
        const h = parseFloat(this.editForm.customHours);
        if (Number.isNaN(h)) {
          this.showError('è«‹è¼¸å…¥è‡ªè¨‚å·¥æ™‚');
          return;
        }
      }

      const dateKey = this.editForm.date;
      const total = this.calcTotalHours(this.editForm.type, this.editForm.customHours, this.editForm.ot);
      const otH = parseFloat(this.editForm.ot ?? 0) || 0;
      const customH = this.editForm.type === 'custom' ? (parseFloat(this.editForm.customHours) || 0) : null;

      this.workDays[dateKey] = {
        date: dateKey,
        type: this.editForm.type,
        ot: otH,
        customHours: customH,
        hours: parseFloat(total.toFixed(2))
      };

      this.showSuccess('å·²æ›´æ–°ï¼');
      this.closeEdit();
    },

    deleteRecord(date) {
      if (!date) return;
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„è¨˜éŒ„ï¼Ÿ`)) return;
      delete this.workDays[date];
      this.showSuccess('å·²åˆªé™¤');
      this.closeEdit();
    },

    formatHours(hours) {
      const h = parseFloat(hours);
      if (Number.isNaN(h)) return '0.00';
      return h.toFixed(2);
    },

    getDayClass(day) {
      if (!day.date) return 'bg-gray-50 border-gray-200 opacity-30 cursor-default';
      if (!day.hasRecord) return 'bg-white/40 border-gray-200 hover:border-gray-300';

      const h = parseFloat(day.hours) || 0;
      if (h >= 12) return 'bg-emerald-100 border-emerald-400 hover:shadow';
      if (h > 0) return 'bg-green-100 border-green-400 hover:shadow';
      if (h < 0) return 'bg-red-100 border-red-400 hover:shadow';
      return 'bg-yellow-100 border-yellow-400 hover:shadow';
    },

    saveData() {
      try {
        localStorage.setItem('workDays', JSON.stringify(this.workDays));
      } catch (e) {
        console.warn('localStorage error', e);
      }
    },

    loadData() {
      try {
        const saved = localStorage.getItem('workDays');
        if (saved) this.workDays = JSON.parse(saved) || {};
      } catch (e) {
        console.error(e);
        this.workDays = {};
      }
    }
  },

  mounted() {
    this.loadData();
    this.newWorkDay.date = this.today;
  }
}).mount('#app');
</script>
</body>
</html>
